# 액션에서 계산 빼내기

쇼핑몰 코드의 문제점 → ‘동작’만 하고 있음… 

개선 방향

- 테스트하기 쉽게 만들기
    - DOM 업데이트와 비즈니스 규칙의 분리
    - 전역 변수 제거하기
- 재사용하기 쉽게 만들기
    - 전역 변수에 의존하지 말아야함
    - 함수가 결과값을 리턴해야 함 → DOM을 사용할 수 있는 곳에서 실행된다고 가정 x

## 함수에는 입력과 출력이 있다

입력과 출력은 명시적이거나 암묵적일 수 있다. (명시적 입력: 인자 / 명시적 출력: 리턴값)

- 입력: 함수가 계산을 하기 위한 외부 정보 (ex. 함수 인자(명시적), 전역변수 읽기(암묵적))
- 출력: 함수 밖으로 나오는 정보나 어떤 동작 (ex. 콘솔 찍기(암묵적), 전역변수 값 변경(암묵적), 리턴값(명시적))

**⇒ 함수에 암묵적 입력과 출력이 있으면 액션이 된다.(부수효과)**

## 액션에서 계산 빼내기

- **암묵적인 입력과 출력을 명시적으로 바꾸기**
- 기존 함수의 내부에서 새로운 함수 빼내기 → 서브루틴 추출 (함수 추출)
- 전역변수 대신 지역변수 사용하기 (리턴된 지역변수를 전역변수에 할당하는 방식으로)
- **카피-온-라이트**: 어떤 값을 바꿀 때 그 값을 복사해서 바꾸는 방법(불변성)

> Q. 인자로 전달한 배열을 직접 변경한다면 그 함수는 계산일까?<br>
A. 액션이다. 외부 상태를 변경하기 때문에 부수효과를 지님.
> 

> Q. 계산에서도 지역변수를 변경하고 있다. 함수형 프로그래밍은 모든 것이 불변값이여야 하는 것이 아닌가<br>
A. 생성할때는 초기화가 필요하다. 지역변수를 변경하는 곳은 나중에 초기화할 값으로 새로 생성한다. 지역 변수이기 때문에 함수 밖에서는 접근 불가능하다. 초기화가 끝나면 해당 값은 리턴한다.
> 

### 📌 계산 추출 단계

1. 계산 코드를 찾아 빼내기
2. 새 함수에 암묵적 입력과 출력 찾기
3. 암묵적 입력은 인자로 암묵적 출력은 리턴값으로 바꾸기

# 더 좋은 액션 만들기

- 암묵적 입력과 출력은 적을수록 좋다
- 설계는 엉켜있는 코드를 푸는 것이다.
    - 엉켜있는 것을 풀면 의미있는 계층이 보인다.
    - 카피-온-라이트 패턴 빼내기 : 인자를 복제하고 지역변수에 할당하는 부분이 중복 → 유틸함수로 분리

# 변경 가능한 데이터 구조를 가진 언어에서 불변성 유지하기

동작은 읽기 또는 쓰기 또는 둘다 하는 것으로 분류 가능

쓰기 동작은 불변성 원칙에 따라 구현해야함

## 카피-온-라이트 원칙

1. 복사본 만들기
2. 복사본 변경하기
3. 복사본 리턴하기

⇒ 직접 데이터를 바꾸지 않았고 정보를 리턴했기 때문에 쓰기를 읽기로 바꿀 수 있다.

- 쓰기와 읽기를 동시에 하는 동작은?
    
    ```js
    var a = [1, 2, 3, 4];
    var b = a.shift() // a 쓰기 및 읽기
    ```
    
    1. 읽기와 쓰기 함수로 각각 분리
        1. 배열의 인덱스0 값을 읽는 함수
        2. 복사한 배열에서 인덱스 0을 제거하고 배열을 반환하는 함수
    2. 함수에서 값을 두개 리턴하기
        
        

## 불변 데이터 구조를 읽는 것은 계산이다

- 변경 가능한 데이터를 읽는 것은 액션
- 쓰기는 데이터를 변경 가능한 구조로 만든다
- 어떤 데이터에 쓰기가 없다면 데이터는 변경 불가능한 데이터
- 불변 데이터 구조를 읽는 것은 계산
- 쓰기를 읽기로 바꾸면 코드에 계산이 많아지고 액션은 줄어든다

중첩된 구조의 객체의 경우에도 카피-온-라이트 패턴을 통해서 불변성 유지 가능. **구조적 공유**

# 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

신뢰할 수 없는 외부 레거시 코드로 인해 불변성이 지켜질 수 있을지 알 수 없을 때 ⇒ **방어적 복사**를 활용

## 방어적 복사

원본이 바뀌는 것을 막기 위해

- 위험지대→ 안전지대로 들어오는 데이터
- 안전지대→ 위험지대로 들어오는 데이터

모두 깊은 복사로 불변성을 유지한다.

방어적 복사가 사용되는 예시 (**비공유 아키텍처**)

- 웹 API 속에 방어적 복사: 요청으로 들어온 JSON 데이터를 api로 보내려고 직렬화 → 이때 JSON 데이터는 깊은 복사본
- 얼랭과 엘릭서

> 카피온라이트는 얕은 복사
<br>방어적 복사는 깊은 복사

JS에서 깊은 복사를 구현하는 것은 어렵다. Lodash 라이브러리의 `.cloneDeep()` 사용
